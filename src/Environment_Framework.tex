%-------------------------------------------------------------------------
% Section: 總結
%-------------------------------------------------------------------------
\chapter{Environment Framework}
\label{cha:Environment Framework}

In this chapter, we introduce the device, environment and software that we used in our experiment. 
%\begin{itemize}
%\item We choose ZedBoard() as our target FGPA platform.
%\item Linux Kernel is compiled from the github repository provided by Xilinx.\cite{xlnxkernel}
%\item Linaro\cite{linarofs} is put in 2nd partition of SD card as our root file system.
%\item All our custom stream IPs are designed(and provided) in Vivado 2016.04.
%\item Device Tree files are generated by SDK 2016.04 and github repository provided by Xilinx\cite{xlnxdevicetree}
%\end{itemize}



\begin{enumerate}[label=(\roman*)]
\item We choose Xilinx ZedBoard as our target FGPA platform.
	\begin{enumerate}
	\item Dual ARM® Cortex™-A9 MPCore™
	\item 512 MB DDR3 memory (1066 Mbps)
	\end{enumerate}
\item Linux Kernel is compiled from the github repository provided by Xilinx.\cite{xlnxkernel}
	\begin{enumerate}
	\item Kernel version is 4.9.0
	\item GCC version is 5.4.0
	\end{enumerate}
\item Linaro\cite{linarofs} is put in 2nd partition of SD card as our root file system.
\item All our custom stream IPs are designed(and provided) in Vivado 2016.04.
\item Devicetree files are generated by SDK 2016.04 and github repository provided by Xilinx\cite{xlnxdevicetree}
\end{enumerate}

Although, we use some relatively old version of Xilinx deveplop software, but our contribution is basiclly out of the version problem. If the version compatible is well handled by Xilinx, our flow and code should work well directly, and if not, only little modification is needed.

\newpage
\section{Some Issues about Devicetree File}
\label{sec:Some Issues about Devicetree File}
This section we talk about some issues about devicetree file. We have mentioned devicetree file in former chapter~\ref{subsec:Device Tree}, but here we'll discuss some problems we met when we do the experiment, and it might be some bugs of devicetree compiler or devicetree generator of Xilinx SDK. Because this is not about how we solve the problem, so we separate this part here.

There may have some wrong settings if you directly use the devicetree file generated by Xilinx SDK. For example, the interrupt settings of DMA controller or our custom IP in deivcetree file may not follow the Vivado design. The interrupt number and interrupt type 
may be not the same as we expect. See the following exaple:{}

{\renewcommand\baselinestretch{0.8}\selectfont
\begin{lstlisting}[frame=single,language=C]
dma@40400000 {
	#dma-cells = <0x1>;
	clock-names = "s_axi_lite_aclk", "m_axi_sg_aclk", "m_axi_mm2s_aclk", "m_axi_s2mm_aclk";
	clocks = <&clk 0xf &clk 0xf &clk 0xf &clk 0xf>;
	compatible = "xlnx,axi-dma-1.00.a";
	interrupt-parent = <0x3>;
	interrupts = <0x0 0x1d 0x4 0x0 0x1e 0x4>;
	reg = <0x40400000 0x10000>;
	xlnx,addrwidth = <0x20>;
\end{lstlisting}
\par}

In ``interrupt'' property,	``interrupts = <0x0 0x1d 0x4 0x0 0x1e 0x4>;'' means we have two interrupts, <0x0 0x1d 0x4> and <0x0 0x1e 0x4> because we have two DMA channel in our design. The second term(0x1d and 0x1e) is the interrupt number and should be determined when we connect DMA controller to the CPU in Vivado design. But in fact, the generated devicetree file sometimes may set wrong number to this term, and  cause the driver can not probe the device correctly. The third terms(in our example, both are 0x4) is the interrupt type, this term is related to how we treat the interrupt signal, because the devicetree compiler can't know how we design, it just put a default value to this term. So make sure that the setting in devicetree file is corresponding with the design. The interrupt type definition is in \cite{intterrupttypes}

Some label problem may happen also. In devicetree, we can define labels for convenience, let's take alook at the above example again, note that, in ``clocks'' property, it uses label ``\&clk'', to get the correct clock, so there must have some settings like:

{\renewcommand\baselinestretch{0.8}\selectfont
\begin{lstlisting}[frame=single,language=C]
clk: clkc@100 {
	#clock-cells = <0x1>;
	compatible = "xlnx,ps7-clkc";
	fclk-enable = <0xf>;
	clock-output-names = "armpll", "ddrpll", "iopll", "cpu_6or4x", "cpu_3or2x", "cpu_2x", "cpu_1x", "ddr2x", "ddr3x", "dci", "lqspi", "smc", "pcap", "gem0", "gem1", "fclk0", "fclk1", "fclk2", "fclk3", "can0", "can1", "sdio0", "sdio1", "uart0", "uart1", "spi0", "spi1", "dma", "usb0_aper", "usb1_aper", "gem0_aper", "gem1_aper", "sdio0_aper", "sdio1_aper", "spi0_aper", "spi1_aper", "can0_aper", "can1_aper", "i2c0_aper", "i2c1_aper", "uart0_aper", "uart1_aper", "gpio_aper", "lqspi_aper", "smc_aper", "swdt", "dbg_trc", "dbg_apb";
	reg = <0x100 0x100>;
	ps-clk-frequency = <0x1fca055>;
	linux,phandle = <0x1>;
	phandle = <0x1>;
};
\end{lstlisting}
\par}

But in the devicetree file generated by SDK, it sometimes use the label without pre-set the label, using the above example, it uses ``\&clk'' in ``dma'' node, but it does not set ``clk'' label to ``clkc'' node. So if there are some error messages about the reference when generating the devicetree file, make sure the above problems is solved.

%-------------------------------------------------------------------------
% Section: 簡單範例和小技巧
%-------------------------------------------------------------------------



